[返回目录](./README.md)

## web 安全之 XSS

### 一、XSS 是什么？

    全称：
        Cross Site Scripting
    简介：
        XSS 攻击，通常指黑客通过 "HTML注入" 篡改了网页，插入了恶意的脚本，从而在用户浏览网页时，控制用户浏览器的一种攻击。在一开始，这种攻击的演示案例是跨域的，所以叫做 "跨站脚本" 。但是发展到今天，由于 JavaScript 的强大功能以及网站前端应用的复杂化，是否是否跨域已经不再重要。但是由于历史原因，XSS 这个名字却一直保留下来。
    释义：
        跨站脚本攻击，通俗的理解就是我的网站只能运行我的东西，如果我的网站运行了别的东西就是跨站攻击。
    本质：
        XSS的本质就是一种HTML注入，用户的数据被当成了HTML代码一部分来执行，从而混淆了原本的语义，产生了新的语义。

### 二、XSS 攻击能做什么？

    如果被 XSS 攻击成功，那么危害后果是非常大的，它能获取页面数据、cookies、劫持前端逻辑、发送请求等等。
    不仅如此还可以偷取网站任意数据、用户资料、用户密码以及登录态等等。可想而知如果这些数据被攻击者获取到，那么后果很验证。

### 三、XSS 攻击分类

    (1)反射型：
        介绍：
            反射型 XSS 只是简单地把用户输入的数据 “反射” 给浏览器。也就是说，黑客往往需要诱使用户 “点击” 一个恶意链接，才能攻击成功。反射型 XSS 也叫做 “非持久型XSS”（Non-persistent XSS）

        攻击步骤：
            1.攻击者构造出特殊的 URL，其中包含恶意代码。
            2.用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
            3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
            4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

    (2)存储型
        介绍：
            存储型 XSS 会把用户输入的数据 “存储” 在服务器端。这种 XSS 具有很强的稳定性。
        
        攻击步骤：
            1.攻击者将恶意代码提交到目标网站的数据库中。
            2.用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。
            3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
            4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

### 四、XSS 攻击的注入点

    这里不会详细展开介绍，记住以下几个点，在下面如何防御时进行理解。

    (1) HTML 节点内容
```html
    <div> { content } </div>
    <div>内容<script>alert('XSS 攻击')</script></div>
```

    (2) HTML 属性
```html
    <!-- 这里的 imageUrl 被替换成了 1" onerror="alert(1) -->
    <img src="{ imageUrl }"/>
    <img src="1" onerror="alert(1)"/>
```
    (3) JavaScript 代码
```js
    // 这里的 data 被替换成了 hello";alert(1);"
    var data = "#{data}"
    var data = "hello";alert(1);"";
```
    (4) 富文本
        富文本得保留 HTML ，毋庸置疑 HTML 是有 XSS 攻击风险的。

    (5)浏览器 DOM 节点编辑
        在用户输入内容的地方通过打开浏览器 DOM 检查更改其属性的方式。

### 五、XSS 攻击防御

    在业内达成共识的是：针对各种不同场景产生的 XSS，需要区分情景对待。也就是说点对点地进行防御。

    (1)浏览器自带防御：
        防御范围：只防御反射型，防御注入点只是 HTML 内容和属性，URL参数出现在 HTML 内容或属性中时
        开启状态：默认是开启XSS防御的,也可以关闭：
            set('X-XSS-Protection',0) 关闭
            set('X-XSS-Protection',1) 开启
            set('X-XSS-Protection',1,URL) 网站出现XSS攻击的时候浏览器会向这个URL发送一个通知

    (2)HTML内容及HTML属性：
        防御措施：转义。进行HTML Entity 编码，转义的时机可以是输入和输出，但是最好在输入的时候，可以节约性能。
```js
    var escapeHTML = function (str) {
        if(!str) return ''
        str.replace(/&/g,"&amp;") // &转义必须放在前面
        str.replace(/"/g,"&quto;")
        str.replace(/'/g,"&#39;")
        str.replace(/ /g,"&#32;")
        str.replace(/</g,"&lt")
        ...
        return str
    }
``` 
    (3)JavaScript 注入点防御
        通过 JSON 传输，JSON.stringfy

    (4)富文本处理
        所谓富文本就是一大段的HTNL 其中会包含很多的格式，要保留 HTML。
        防御措施：过滤
        防御思想：
            按白名单保留部分标签和属性
            白名单：处理比较彻底，但是实现麻烦，富文本允许的标签和属性罗列出来。
            黑名单：风险比较大，因为 HTML 标签属性太多
        过滤节点：用户输入的时候，可以节约性能
        过滤步骤：
            解析HTML返回 DOM 树结构，针对 DOM 树一个一个去遍历它的元素，然后看它是否为我们允许的标签和属性，如果是不做处理，如果不是就去掉。

        第三方库推荐：
            npm install xss --save

### 六、现代开发框架下的 XSS 防御
    
    前提：前端 采用 MVVM 模式开发框架 Vue、React。
    不论是 Vue 还是 React 都是已经非常成熟的框架了，它的编译已经很大程度避免了 XSS 风险。
    但是有一种情况我们不得不将用户输入的内容保持不变的渲染到页面中，（也就是代码中执行了 innerHTML 的地方），
    其内容会被执行，存在风险，那就是富文本。
    具体解决方案参考上述的富文本防御。
    
    再次回顾一下 XSS 的本质，是一种 HTML 注入，用户的数据被当成了HTML代码一部分来执行，从而混淆了原本的语义，产生了新的语义。
